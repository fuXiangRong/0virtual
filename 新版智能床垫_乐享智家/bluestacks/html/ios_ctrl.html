<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>理疗设备 IOS 蓝牙控制</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../../com/css/min/mui.min.css">
		<link rel="stylesheet" href="../../com/css/other/com.css">
		<link rel="stylesheet" href="../css/blue.css">
	</head>

	<body id="body_id" class="set-body">
		<div id="remoteCtrl" class="mui-slider-item" style="display: none;">
			<div class="rc_show">
				<!-- 信息显示区域 采用的是浮动布局 -->
				<span>左侧</span><span>右侧</span>
				<li index="0" class="info">获取中</li>
				<li index="0" class="info">获取中</li>
				<em index="0" class="info">待机</em>
				<em index="0" class="info">待机</em>
			</div>
			<div class="rc_ctrl">
				<!-- 控制区域  采用绝对定位布局-->
				<span index="0" type="1" class="span_lt switch">左加热</span>
				<span index="1" type="1" class="span_rt switch">右加热</span>
				<span index="2" type="2" class="span_lb switch">左理疗</span>
				<span index="3" type="2" class="span_rb switch">右理疗</span>
				<!-- 内容是图片显示 依次是左上 右上 中间 左下 右下  -->
				<ul>
					<li index="4" class="li_lt switch"></li>
					<li index="5" class="li_rt switch"></li>
					<li index="6" class="li_cc switch"></li>
					<li index="7" class="li_lb switch"></li>
					<li index="8" class="li_rb switch"></li>
				</ul>
			</div>
		</div>
		<div class="mui-content-padded">
			<input type="button" class="mui-btn" value="创建管理器" onclick="create()" />
			<input type="button" class="mui-btn" value="扫描外设" onclick="scan()" />
			<input type="button" class="mui-btn" value="清空输出内容" onclick="clearResult()" />
			<div id='result'></div>
		</div>
	</body>
	</body>

	<script src="../../com/js/min/mui.min.js"></script>
	<script src="../../com/js/other/data.js"></script>
	<script src="../../com/js/other/com.js"></script>
	<script src="../js/blue.ios.js"></script>
	<script src="../js/android.ctrl.js"></script>
	<!--<script src="../../com/js/min/mui.pullToRefresh.js"></script>-->

	<script type="text/javascript">
		//		mui.plusReady(ANDROID_CTRL.start);
		//		mui.plusReady(function() {
		//			searchIOS();
		//		});
		mui.init();
		var CBCentralManager = plus.ios.importClass("CBCentralManager");
		var CBPeripheralDelegate = plus.ios.importClass("CBPeripheralDelegate");
		var CBPeripheral = plus.ios.importClass("CBPeripheral");
		var NSMutableArray = plus.ios.importClass("NSMutableArray");
		var CBPeripheral = plus.ios.importClass("CBPeripheral");
		var CBService = plus.ios.importClass("CBService");
		var CBCharacteristic = plus.ios.importClass("CBCharacteristic");
		var CBUUID = plus.ios.importClass("CBUUID");
		//1.中央外设管理器
		var manager = null;
		var peripherals = null;
		var peripheral_delegate = null;
		var delegate = null;

		function create() {
			// 1.创建外设管理器
			manager = new CBCentralManager();
			peripherals = (new NSMutableArray()).init();

			delegate = plus.ios.implements("CBCentralManagerDelegate", {
				"centralManagerDidUpdateState:": centralManagerDidUpdateState,
//				"centralManagerdidDiscoverPeripheraladvertisementDataRSSI:": didDiscoverPeripheral,
				"centralManager:didDiscoverPeripheral:advertisementData:RSSI:": didDiscoverPeripheral1
			});
			console.log(delegate.callBack);
			console.log(JSON.stringify(delegate));
			//			manager.initWithDelegatequeue(null, null);

			output('>>1. 中央外设管理器 CBCentralManager 创建成功<br>');
			console.log('>>1. 中央外设管理器 CBCentralManager 创建成功<br>');

			//			manager.scanForPeripheralsWithServicesoptions(null, null);
		}
		//2. 扫描所有外设
		function scan() {
			// 实现代理

			output('>>3. 开始扫描蓝牙外设....<br>');
			console.log('>>3. 开始扫描蓝牙外设....<br>');
			manager = manager.initWithDelegatequeue(delegate, null);

		}

		function centralManagerDidUpdateState(central) {
			var state = central.plusGetAttribute('state');
			output(">>2. 中央外设管理器状态 state= " + state + '<br>');
			console.log(">>2. 中央外设管理器状态 state= " + state + '<br>');
			if(state == 4) {
				mui.alert('请开启蓝牙');
			}
			if(state == 5) {
				console.log('蓝牙属于开启,执行扫描');
				manager.scanForPeripheralsWithServicesoptions(null, null);
			}
		}

		//第三步：扫描完成，发现设备，添加到设备列表中
		function didDiscoverPeripheral(central, peripheral, advertisementData, RSSI) {
			output('>>4. 发现蓝牙外设 didDiscoverPeripheral')
			console.log('>>4. 发现蓝牙外设 didDiscoverPeripheral')
			output('<br>central=' + JSON.stringify(central));
			console.log('<br>central=' + JSON.stringify(central));

			//为什么能发现，但获取不到蓝牙设备，以下三个值均返回 undefined
			output('<br>peripheral=' + JSON.stringify(peripheral));
			output('<br>advertisementData=' + JSON.stringify(advertisementData));
			output('<br>RSSI=' + JSON.stringify(RSSI));
			if(!peripherals.containsObject(peripheral)) {
				if(!peripheral_delegate) {
					var peripheral_delegate = plus.ios.implements("CBPeripheralDelegate", {
						"peripheral:didDiscoverServices::": peripheraldidDiscoverServices,
						"peripheral:didUpdateValueForCharacteristic:error:": peripheraldidDiscoverCharacteristicsForServiceerror,
						"peripheral:didWriteValueForCharacteristic:error:": peripheraldidWriteValueForCharacteristiccharacteristicerror,
					});
				}
				eripheral.setDelegate = peripheral_delegate;
				peripherals.addObject(peripheral);
			}
		}
		//第三步：扫描完成，发现设备，添加到设备列表中
		function didDiscoverPeripheral1(central, peripheral, advertisementData, RSSI) {
			output('>>4. 发现蓝牙外设 didDiscoverPeripheral1')
			console.log('>>4. 发现蓝牙外设 didDiscoverPeripheral1')
			output('<br>central=' + JSON.stringify(central));
			console.log('<br>central=' + JSON.stringify(central));

			//为什么能发现，但获取不到蓝牙设备，以下三个值均返回 undefined
			output('<br>peripheral=' + JSON.stringify(peripheral));
			output('<br>advertisementData=' + JSON.stringify(advertisementData));
			output('<br>RSSI=' + JSON.stringify(RSSI));
			if(!peripherals.containsObject(peripheral)) {
				if(!peripheral_delegate) {
					var peripheral_delegate = plus.ios.implements("CBPeripheralDelegate", {
						"peripheral:didDiscoverServices::": peripheraldidDiscoverServices,
						"peripheral:didUpdateValueForCharacteristic:error:": peripheraldidDiscoverCharacteristicsForServiceerror,
						"peripheral:didWriteValueForCharacteristic:error:": peripheraldidWriteValueForCharacteristiccharacteristicerror,
					});
				}
				eripheral.setDelegate = peripheral_delegate;
				peripherals.addObject(peripheral);
			}
		}

		//第四步：连接蓝牙设备
		function connect(devName) {
			if(manager.state() == 5) {
				var len = peripherals.count();
				for(var i = 0; i < len; i++) {
					var item = peripherals.objectAtIndex(i);
					if(item.name() === devName) {
						manager.connectPeripheraloptions(item, null);
						break;
					}
				}
			}
		}

		//第五步：连接成功，扫描蓝牙设备的服务
		function centralManagerdidConnectPeripheral(central, peripheral) {
			peripheral.discoverServices(null);
		}

		//第六步：扫描到外设的所有服务后，筛选指定的服务，扫描该服务的特性
		function peripheraldidDiscoverServices(peripheral, error) {
			var serUID = CBUUID.UUIDWithString("");
			var services = peripheral.services();
			var len = services.count();
			for(var i = 0; i < len; i++) {
				var item = services.objectAtIndex(i);
				if(item.UUID() === serUID) {
					peripheral.discoverCharacteristicsforService(null, item);
					break;
				}
			}
		}

		//第七步：扫描到指定服务的特性后，筛选指定的特性，进行交互
		function peripheraldidDiscoverCharacteristicsForServiceerror(peripheral, service, error) {
			var characteristics = peripheral.characteristics();
			var serUID = CBUUID.UUIDWithString("");
			var len = characteristics.count();
			for(var i = 0; i < len; i++) {
				var characteristic = characteristics.objectAtIndex(i);
				if(characteristic.UUID() === serUID) {
					var data = null;
					peripheral.writeValueforCharacteristictype(data, characteristic, 0);
				}
			}
		}

		function peripheraldidWriteValueForCharacteristiccharacteristicerror(peripheral, characteristic, error) {
			output(">>7. 打印完成 <br>");
		}

		function centralManagerdidDisconnectPeripheralperipheralerror(central, peripheral, error) {
			output(">>已断开连接 <br>");
		}

		function output(msg) {
			document.getElementById('result').innerHTML += msg + '<br>';
		}

		function clearResult() {
 			plus.ios.autoCollection(delegate);
 			plus.ios.autoCollection(peripherals);
 			plus.ios.autoCollection(manager);
			document.getElementById('result').innerHTML = '';
		}
		mui.plusReady(function() {
			create();
			//			scan();
		});
	</script>

</html>